# Script de despliegue completo para RedP2P
# Realiza una instalaci√≥n limpia de todos los servicios y abre la interfaz web

param(
    [switch]$SkipCleanup,
    [switch]$SkipBuild,
    [switch]$SkipTests,
    [string]$Browser = "default"
)

# Configuraci√≥n
$ProjectName = "RedP2P"
$CentralServerUrl = "http://localhost:8000"
$NetworkName = "p2p-network"
$Timeout = 60

# Colores para output
$Colors = @{
    Success = "Green"
    Warning = "Yellow"
    Error = "Red"
    Info = "Cyan"
    Header = "Magenta"
}

function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White",
        [string]$Prefix = ""
    )
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-Host "[$timestamp] $Prefix$Message" -ForegroundColor $Color
}

function Write-Header {
    param([string]$Title)
    Write-Host ""
    Write-Host "=" * 60 -ForegroundColor $Colors.Header
    Write-Host "  $Title" -ForegroundColor $Colors.Header
    Write-Host "=" * 60 -ForegroundColor $Colors.Header
    Write-Host ""
}

function Write-Step {
    param(
        [int]$Step,
        [int]$Total,
        [string]$Message
    )
    Write-ColorOutput "Paso $Step/$Total - $Message" $Colors.Info "üîß "
}

function Test-Command {
    param([string]$Command)
    try {
        Get-Command $Command -ErrorAction Stop | Out-Null
        return $true
    } catch {
        return $false
    }
}

function Wait-ForService {
    param(
        [string]$Url,
        [string]$ServiceName,
        [int]$MaxWait = 60
    )
    
    Write-ColorOutput "Esperando que $ServiceName est√© disponible..." $Colors.Info "‚è≥ "
    
    $elapsed = 0
    while ($elapsed -lt $MaxWait) {
        try {
            $response = Invoke-WebRequest -Uri $Url -TimeoutSec 5 -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
                Write-ColorOutput "$ServiceName est√° disponible" $Colors.Success "‚úÖ "
                return $true
            }
        } catch {
            # Servicio a√∫n no disponible
        }
        
        Start-Sleep -Seconds 2
        $elapsed += 2
        Write-Progress -Activity "Esperando $ServiceName" -Status "Tiempo transcurrido: $elapsed segundos" -PercentComplete (($elapsed / $MaxWait) * 100)
    }
    
    Write-Progress -Activity "Esperando $ServiceName" -Completed
    Write-ColorOutput "$ServiceName no est√° disponible despu√©s de $MaxWait segundos" $Colors.Error "‚ùå "
    return $false
}

function Open-Browser {
    param([string]$Url)
    
    Write-ColorOutput "Abriendo interfaz web en el navegador..." $Colors.Info "üåê "
    
    try {
        switch ($Browser.ToLower()) {
            "chrome" { Start-Process "chrome" $Url }
            "firefox" { Start-Process "firefox" $Url }
            "edge" { Start-Process "msedge" $Url }
            "default" { Start-Process $Url }
            default { Start-Process $Url }
        }
        Write-ColorOutput "Navegador abierto en $Url" $Colors.Success "‚úÖ "
    } catch {
        Write-ColorOutput "No se pudo abrir el navegador autom√°ticamente" $Colors.Warning "‚ö†Ô∏è "
        Write-ColorOutput "Abra manualmente: $Url" $Colors.Info "üí° "
    }
}

# Inicio del script
Write-Header "üöÄ DESPLIEGUE COMPLETO DE $ProjectName"

# Verificar prerrequisitos
Write-Step 1 9 "Verificando prerrequisitos..."

$prerequisites = @{
    "Docker" = Test-Command "docker"
    "Docker Compose" = Test-Command "docker-compose"
}

$missingPrereqs = @()
foreach ($prereq in $prerequisites.GetEnumerator()) {
    if ($prereq.Value) {
        Write-ColorOutput "$($prereq.Key) est√° instalado" $Colors.Success "‚úÖ "
    } else {
        Write-ColorOutput "$($prereq.Key) NO est√° instalado" $Colors.Error "‚ùå "
        $missingPrereqs += $prereq.Key
    }
}

if ($missingPrereqs.Count -gt 0) {
    Write-ColorOutput "Prerrequisitos faltantes: $($missingPrereqs -join ', ')" $Colors.Error "‚ùå "
    Write-ColorOutput "Instale los prerrequisitos antes de continuar" $Colors.Error "‚ùå "
    exit 1
}

# Limpiar instalaci√≥n anterior
if (-not $SkipCleanup) {
    Write-Step 2 9 "Limpiando instalaci√≥n anterior..."
    
    Write-ColorOutput "Deteniendo contenedores existentes..." $Colors.Info "üõë "
    docker-compose down --remove-orphans 2>$null
    
    Write-ColorOutput "Eliminando contenedores hu√©rfanos..." $Colors.Info "üóëÔ∏è "
    docker container prune -f 2>$null
    
    Write-ColorOutput "Eliminando im√°genes no utilizadas..." $Colors.Info "üóëÔ∏è "
    docker image prune -f 2>$null
    
    Write-ColorOutput "Limpieza completada" $Colors.Success "‚úÖ "
} else {
    Write-ColorOutput "Saltando limpieza (--SkipCleanup especificado)" $Colors.Warning "‚ö†Ô∏è "
}

# Configurar red Docker (manejada autom√°ticamente por Docker Compose)
Write-Step 3 9 "Configurando red Docker..."

Write-ColorOutput "La red '$NetworkName' ser√° creada autom√°ticamente por Docker Compose" $Colors.Info "‚ÑπÔ∏è "

# Crear directorios necesarios
Write-Step 4 9 "Creando estructura de directorios..."

$directories = @(
    "data/central-server",
    "data/shared-files/peer1",
    "data/shared-files/peer2", 
    "data/shared-files/peer3",
    "config"
)

foreach ($dir in $directories) {
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
        Write-ColorOutput "Directorio '$dir' creado" $Colors.Success "üìÅ "
    } else {
        Write-ColorOutput "Directorio '$dir' ya existe" $Colors.Info "‚ÑπÔ∏è "
    }
}

# Construir im√°genes
if (-not $SkipBuild) {
    Write-Step 5 9 "Construyendo im√°genes Docker..."
    
    Write-ColorOutput "Construyendo imagen del servidor central..." $Colors.Info "üî® "
    docker-compose build central-server
    if ($LASTEXITCODE -ne 0) {
        Write-ColorOutput "Error construyendo servidor central" $Colors.Error "‚ùå "
        exit 1
    }
    
    Write-ColorOutput "Construyendo imagen de nodos peer..." $Colors.Info "üî® "
    docker-compose build peer-node-1 peer-node-2 peer-node-3
    if ($LASTEXITCODE -ne 0) {
        Write-ColorOutput "Error construyendo nodos peer" $Colors.Error "‚ùå "
        exit 1
    }
    
    Write-ColorOutput "Im√°genes construidas correctamente" $Colors.Success "‚úÖ "
} else {
    Write-ColorOutput "Saltando construcci√≥n (--SkipBuild especificado)" $Colors.Warning "‚ö†Ô∏è "
}

# Recrear base de datos
Write-Step 6 9 "Recreando base de datos..."

# Ejecutar dentro del contenedor para usar dependencias (SQLAlchemy)
$dbUrl = "sqlite:///./data/central_server.db"

Write-ColorOutput "Ejecutando creaci√≥n de tablas dentro del contenedor..." $Colors.Info "üóÑÔ∏è "
$args = @(
    "run",
    "--rm",
    "-e", "DATABASE_URL=$dbUrl",
    "central-server",
    "python", "/app/init_db.py"
)

$proc = Start-Process -FilePath "docker-compose" -ArgumentList $args -NoNewWindow -PassThru -Wait

if ($proc.ExitCode -ne 0) {
    Write-ColorOutput "Error recreando base de datos (docker-compose run)" $Colors.Error "‚ùå "
    exit 1
}

Write-ColorOutput "Base de datos recreada correctamente" $Colors.Success "‚úÖ "

# Iniciar servicios
Write-Step 7 9 "Iniciando servicios..."

Write-ColorOutput "Iniciando servidor central..." $Colors.Info "üöÄ "
docker-compose up -d central-server
if ($LASTEXITCODE -ne 0) {
    Write-ColorOutput "Error iniciando servidor central" $Colors.Error "‚ùå "
    exit 1
}

# Esperar a que el servidor central est√© disponible
if (-not (Wait-ForService "$CentralServerUrl/api/health" "Servidor Central" $Timeout)) {
    Write-ColorOutput "El servidor central no est√° respondiendo" $Colors.Error "‚ùå "
    Write-ColorOutput "Revisando logs del servidor central..." $Colors.Info "üìã "
    docker logs p2p-central-server --tail 20
    exit 1
}

Write-ColorOutput "Iniciando nodos peer..." $Colors.Info "üöÄ "
docker-compose up -d peer-node-1 peer-node-2 peer-node-3
if ($LASTEXITCODE -ne 0) {
    Write-ColorOutput "Error iniciando nodos peer" $Colors.Error "‚ùå "
    exit 1
}

# Esperar a que los peers se registren
Write-ColorOutput "Esperando que los peers se registren..." $Colors.Info "‚è≥ "
Start-Sleep -Seconds 10

# Verificar estado de los servicios
Write-Step 8 9 "Verificando estado de los servicios..."

$services = @(
    @{Name="Servidor Central"; Container="p2p-central-server"; Port=8000},
    @{Name="Peer 1"; Container="p2p-peer-1"; Port=8001},
    @{Name="Peer 2"; Container="p2p-peer-2"; Port=8002},
    @{Name="Peer 3"; Container="p2p-peer-3"; Port=8003}
)

$allServicesRunning = $true
foreach ($service in $services) {
    $containerStatus = docker inspect $service.Container --format "{{.State.Status}}" 2>$null
    if ($containerStatus -eq "running") {
        Write-ColorOutput "$($service.Name) est√° ejecut√°ndose" $Colors.Success "‚úÖ "
    } else {
        Write-ColorOutput "$($service.Name) NO est√° ejecut√°ndose (Estado: $containerStatus)" $Colors.Error "‚ùå "
        $allServicesRunning = $false
    }
}

if (-not $allServicesRunning) {
    Write-ColorOutput "Algunos servicios no est√°n ejecut√°ndose correctamente" $Colors.Error "‚ùå "
    Write-ColorOutput "Revisando logs..." $Colors.Info "üìã "
    docker-compose logs --tail 10
    exit 1
}

# Ejecutar pruebas
if (-not $SkipTests) {
    Write-Step 9 9 "Ejecutando pruebas del sistema..."
    
    $testScript = Join-Path $PSScriptRoot "scripts\test_web_interface.ps1"
    if (Test-Path $testScript) {
        Write-ColorOutput "Ejecutando pruebas de la interfaz web..." $Colors.Info "üß™ "
        & $testScript -ServerUrl $CentralServerUrl -Timeout 30
        if ($LASTEXITCODE -eq 0) {
            Write-ColorOutput "Pruebas completadas exitosamente" $Colors.Success "‚úÖ "
        } else {
            Write-ColorOutput "Algunas pruebas fallaron" $Colors.Warning "‚ö†Ô∏è "
        }
    } else {
        Write-ColorOutput "Script de pruebas no encontrado, saltando..." $Colors.Warning "‚ö†Ô∏è "
    }
} else {
    Write-ColorOutput "Saltando pruebas (--SkipTests especificado)" $Colors.Warning "‚ö†Ô∏è "
}

# Mostrar informaci√≥n del sistema
Write-Header "üìä INFORMACI√ìN DEL SISTEMA"

Write-ColorOutput "Servicios desplegados:" $Colors.Info "‚ÑπÔ∏è "
Write-ColorOutput "  ‚Ä¢ Servidor Central: $CentralServerUrl" $Colors.Success "üåê "
Write-ColorOutput "  ‚Ä¢ Peer 1: http://localhost:8001" $Colors.Success "üåê "
Write-ColorOutput "  ‚Ä¢ Peer 2: http://localhost:8002" $Colors.Success "üåê "
Write-ColorOutput "  ‚Ä¢ Peer 3: http://localhost:8003" $Colors.Success "üåê "

Write-ColorOutput "`nComandos √∫tiles:" $Colors.Info "‚ÑπÔ∏è "
Write-ColorOutput "  ‚Ä¢ Ver logs: docker-compose logs -f" $Colors.Info "üìã "
Write-ColorOutput "  ‚Ä¢ Detener: docker-compose down" $Colors.Info "üõë "
Write-ColorOutput "  ‚Ä¢ Reiniciar: docker-compose restart" $Colors.Info "üîÑ "
Write-ColorOutput "  ‚Ä¢ Estado: docker-compose ps" $Colors.Info "üìä "

# Abrir interfaz web
Write-Header "üåê ABRIENDO INTERFAZ WEB"

Open-Browser $CentralServerUrl

# Esperar un momento para que el navegador se abra
Start-Sleep -Seconds 2

Write-Header "üéâ DESPLIEGUE COMPLETADO"

Write-ColorOutput "¬°RedP2P ha sido desplegado exitosamente!" $Colors.Success "üéâ "
Write-ColorOutput "La interfaz web deber√≠a abrirse autom√°ticamente en tu navegador" $Colors.Success "üåê "
Write-ColorOutput "Si no se abre, visita manualmente: $CentralServerUrl" $Colors.Info "üí° "

Write-ColorOutput "`nPara detener el sistema, ejecuta:" $Colors.Info "‚ÑπÔ∏è "
Write-ColorOutput "  docker-compose down" $Colors.Warning "‚ö†Ô∏è "

Write-ColorOutput "`n¬°Disfruta usando RedP2P! üöÄ" $Colors.Success "‚ú® "
