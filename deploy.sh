#!/bin/bash

# Script de despliegue completo para RedP2P
# Realiza una instalaci√≥n limpia de todos los servicios y abre la interfaz web

# Configuraci√≥n
PROJECT_NAME="RedP2P"
CENTRAL_SERVER_URL="http://localhost:8000"
NETWORK_NAME="p2p-network"
TIMEOUT=60

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Par√°metros
SKIP_CLEANUP=false
SKIP_BUILD=false
SKIP_TESTS=false
BROWSER="default"

# Funci√≥n para mostrar ayuda
show_help() {
    echo "Uso: $0 [OPCIONES]"
    echo ""
    echo "Opciones:"
    echo "  --skip-cleanup    Saltar limpieza de instalaci√≥n anterior"
    echo "  --skip-build      Saltar construcci√≥n de im√°genes Docker"
    echo "  --skip-tests      Saltar ejecuci√≥n de pruebas"
    echo "  --browser BROWSER Especificar navegador (chrome, firefox, default)"
    echo "  -h, --help        Mostrar esta ayuda"
    echo ""
    echo "Ejemplos:"
    echo "  $0                           # Despliegue completo"
    echo "  $0 --skip-cleanup           # Saltar limpieza"
    echo "  $0 --browser chrome         # Usar Chrome"
}

# Procesar argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        --skip-cleanup)
            SKIP_CLEANUP=true
            shift
            ;;
        --skip-build)
            SKIP_BUILD=true
            shift
            ;;
        --skip-tests)
            SKIP_TESTS=true
            shift
            ;;
        --browser)
            BROWSER="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Opci√≥n desconocida: $1"
            show_help
            exit 1
            ;;
    esac
done

# Funciones de utilidad
print_color() {
    local color=$1
    local message=$2
    local prefix=$3
    local timestamp=$(date +"%H:%M:%S")
    echo -e "${color}[$timestamp] $prefix$message${NC}"
}

print_header() {
    local title=$1
    echo ""
    echo -e "${MAGENTA}============================================================${NC}"
    echo -e "${MAGENTA}  $title${NC}"
    echo -e "${MAGENTA}============================================================${NC}"
    echo ""
}

print_step() {
    local step=$1
    local total=$2
    local message=$3
    print_color $CYAN "Paso $step/$total - $message" "üîß "
}

test_command() {
    local cmd=$1
    if command -v "$cmd" &> /dev/null; then
        return 0
    else
        return 1
    fi
}

wait_for_service() {
    local url=$1
    local service_name=$2
    local max_wait=${3:-60}
    
    print_color $CYAN "Esperando que $service_name est√© disponible..." "‚è≥ "
    
    local elapsed=0
    while [ $elapsed -lt $max_wait ]; do
        if curl -s -f "$url" > /dev/null 2>&1; then
            print_color $GREEN "$service_name est√° disponible" "‚úÖ "
            return 0
        fi
        
        sleep 2
        elapsed=$((elapsed + 2))
        printf "\r‚è≥ Esperando $service_name... %d/%d segundos" $elapsed $max_wait
    done
    
    echo ""
    print_color $RED "$service_name no est√° disponible despu√©s de $max_wait segundos" "‚ùå "
    return 1
}

open_browser() {
    local url=$1
    
    print_color $CYAN "Abriendo interfaz web en el navegador..." "üåê "
    
    case $BROWSER in
        "chrome")
            google-chrome "$url" 2>/dev/null || chromium-browser "$url" 2>/dev/null || print_color $YELLOW "Chrome no encontrado" "‚ö†Ô∏è "
            ;;
        "firefox")
            firefox "$url" 2>/dev/null || print_color $YELLOW "Firefox no encontrado" "‚ö†Ô∏è "
            ;;
        "default"|*)
            if command -v xdg-open &> /dev/null; then
                xdg-open "$url" 2>/dev/null
            elif command -v open &> /dev/null; then
                open "$url" 2>/dev/null
            else
                print_color $YELLOW "No se pudo abrir el navegador autom√°ticamente" "‚ö†Ô∏è "
                print_color $CYAN "Abra manualmente: $url" "üí° "
                return
            fi
            ;;
    esac
    
    print_color $GREEN "Navegador abierto en $url" "‚úÖ "
}

# Inicio del script
print_header "üöÄ DESPLIEGUE COMPLETO DE $PROJECT_NAME"

# Verificar prerrequisitos
print_step 1 9 "Verificando prerrequisitos..."

if test_command "docker"; then
    print_color $GREEN "Docker est√° instalado" "‚úÖ "
else
    print_color $RED "Docker NO est√° instalado" "‚ùå "
    exit 1
fi

if test_command "docker-compose"; then
    print_color $GREEN "Docker Compose est√° instalado" "‚úÖ "
else
    print_color $RED "Docker Compose NO est√° instalado" "‚ùå "
    exit 1
fi

# Limpiar instalaci√≥n anterior
if [ "$SKIP_CLEANUP" = false ]; then
    print_step 2 9 "Limpiando instalaci√≥n anterior..."
    
    print_color $CYAN "Deteniendo contenedores existentes..." "üõë "
    docker-compose down --remove-orphans 2>/dev/null
    
    print_color $CYAN "Eliminando contenedores hu√©rfanos..." "üóëÔ∏è "
    docker container prune -f 2>/dev/null
    
    print_color $CYAN "Eliminando im√°genes no utilizadas..." "üóëÔ∏è "
    docker image prune -f 2>/dev/null
    
    print_color $GREEN "Limpieza completada" "‚úÖ "
else
    print_color $YELLOW "Saltando limpieza (--skip-cleanup especificado)" "‚ö†Ô∏è "
fi

# Crear red Docker
print_step 3 9 "Configurando red Docker..."

if docker network ls --format "{{.Name}}" | grep -q "^$NETWORK_NAME$"; then
    print_color $CYAN "Red '$NETWORK_NAME' ya existe" "‚ÑπÔ∏è "
else
    print_color $CYAN "Creando red '$NETWORK_NAME'..." "üåê "
    if docker network create "$NETWORK_NAME" 2>/dev/null; then
        print_color $GREEN "Red '$NETWORK_NAME' creada" "‚úÖ "
    else
        print_color $RED "Error creando red '$NETWORK_NAME'" "‚ùå "
        exit 1
    fi
fi

# Crear directorios necesarios
print_step 4 9 "Creando estructura de directorios..."

directories=(
    "data/central-server"
    "data/shared-files/peer1"
    "data/shared-files/peer2"
    "data/shared-files/peer3"
    "config"
)

for dir in "${directories[@]}"; do
    if [ ! -d "$dir" ]; then
        mkdir -p "$dir"
        print_color $GREEN "Directorio '$dir' creado" "üìÅ "
    else
        print_color $CYAN "Directorio '$dir' ya existe" "‚ÑπÔ∏è "
    fi
done

# Construir im√°genes
if [ "$SKIP_BUILD" = false ]; then
    print_step 5 9 "Construyendo im√°genes Docker..."
    
    print_color $CYAN "Construyendo imagen del servidor central..." "üî® "
    if ! docker-compose build central-server; then
        print_color $RED "Error construyendo servidor central" "‚ùå "
        exit 1
    fi
    
    print_color $CYAN "Construyendo imagen de nodos peer..." "üî® "
    if ! docker-compose build peer-node-1 peer-node-2 peer-node-3; then
        print_color $RED "Error construyendo nodos peer" "‚ùå "
        exit 1
    fi
    
    print_color $GREEN "Im√°genes construidas correctamente" "‚úÖ "
else
    print_color $YELLOW "Saltando construcci√≥n (--skip-build especificado)" "‚ö†Ô∏è "
fi

# Recrear base de datos
print_step 6 9 "Recreando base de datos..."

# Ejecutar dentro del contenedor para usar dependencias (SQLAlchemy)
DB_URL="sqlite:////app/data/central_server.db"
print_color $CYAN "Ejecutando creaci√≥n de tablas dentro del contenedor..." "üóÑÔ∏è "
if ! docker-compose run --rm -e DATABASE_URL="$DB_URL" central-server python /app/init_db.py; then
    print_color $RED "Error recreando base de datos (docker-compose run)" "‚ùå "
    exit 1
fi
print_color $GREEN "Base de datos recreada correctamente" "‚úÖ "

# Iniciar servicios
print_step 7 9 "Iniciando servicios..."

print_color $CYAN "Iniciando servidor central..." "üöÄ "
if ! docker-compose up -d central-server; then
    print_color $RED "Error iniciando servidor central" "‚ùå "
    exit 1
fi

# Esperar a que el servidor central est√© disponible
if ! wait_for_service "$CENTRAL_SERVER_URL/api/health" "Servidor Central" $TIMEOUT; then
    print_color $RED "El servidor central no est√° respondiendo" "‚ùå "
    print_color $CYAN "Revisando logs del servidor central..." "üìã "
    docker logs p2p-central-server --tail 20
    exit 1
fi

print_color $CYAN "Iniciando nodos peer..." "üöÄ "
if ! docker-compose up -d peer-node-1 peer-node-2 peer-node-3; then
    print_color $RED "Error iniciando nodos peer" "‚ùå "
    exit 1
fi

# Esperar a que los peers se registren
print_color $CYAN "Esperando que los peers se registren..." "‚è≥ "
sleep 10

# Verificar estado de los servicios
print_step 8 9 "Verificando estado de los servicios..."

services=(
    "p2p-central-server:8000:Servidor Central"
    "p2p-peer-1:8001:Peer 1"
    "p2p-peer-2:8002:Peer 2"
    "p2p-peer-3:8003:Peer 3"
)

all_services_running=true
for service in "${services[@]}"; do
    IFS=':' read -r container port name <<< "$service"
    container_status=$(docker inspect "$container" --format "{{.State.Status}}" 2>/dev/null)
    
    if [ "$container_status" = "running" ]; then
        print_color $GREEN "$name est√° ejecut√°ndose" "‚úÖ "
    else
        print_color $RED "$name NO est√° ejecut√°ndose (Estado: $container_status)" "‚ùå "
        all_services_running=false
    fi
done

if [ "$all_services_running" = false ]; then
    print_color $RED "Algunos servicios no est√°n ejecut√°ndose correctamente" "‚ùå "
    print_color $CYAN "Revisando logs..." "üìã "
    docker-compose logs --tail 10
    exit 1
fi

# Ejecutar pruebas
if [ "$SKIP_TESTS" = false ]; then
    print_step 9 9 "Ejecutando pruebas del sistema..."
    
    test_script="scripts/test_web_interface.py"
    if [ -f "$test_script" ]; then
        print_color $CYAN "Ejecutando pruebas de la interfaz web..." "üß™ "
        if python3 "$test_script" --url "$CENTRAL_SERVER_URL" --timeout 30; then
            print_color $GREEN "Pruebas completadas exitosamente" "‚úÖ "
        else
            print_color $YELLOW "Algunas pruebas fallaron" "‚ö†Ô∏è "
        fi
    else
        print_color $YELLOW "Script de pruebas no encontrado, saltando..." "‚ö†Ô∏è "
    fi
else
    print_color $YELLOW "Saltando pruebas (--skip-tests especificado)" "‚ö†Ô∏è "
fi

# Mostrar informaci√≥n del sistema
print_header "üìä INFORMACI√ìN DEL SISTEMA"

print_color $CYAN "Servicios desplegados:" "‚ÑπÔ∏è "
print_color $GREEN "  ‚Ä¢ Servidor Central: $CENTRAL_SERVER_URL" "üåê "
print_color $GREEN "  ‚Ä¢ Peer 1: http://localhost:8001" "üåê "
print_color $GREEN "  ‚Ä¢ Peer 2: http://localhost:8002" "üåê "
print_color $GREEN "  ‚Ä¢ Peer 3: http://localhost:8003" "üåê "

print_color $CYAN "Comandos √∫tiles:" "‚ÑπÔ∏è "
print_color $CYAN "  ‚Ä¢ Ver logs: docker-compose logs -f" "üìã "
print_color $CYAN "  ‚Ä¢ Detener: docker-compose down" "üõë "
print_color $CYAN "  ‚Ä¢ Reiniciar: docker-compose restart" "üîÑ "
print_color $CYAN "  ‚Ä¢ Estado: docker-compose ps" "üìä "

# Abrir interfaz web
print_header "üåê ABRIENDO INTERFAZ WEB"

open_browser "$CENTRAL_SERVER_URL"

# Esperar un momento para que el navegador se abra
sleep 2

print_header "üéâ DESPLIEGUE COMPLETADO"

print_color $GREEN "¬°RedP2P ha sido desplegado exitosamente!" "üéâ "
print_color $GREEN "La interfaz web deber√≠a abrirse autom√°ticamente en tu navegador" "üåê "
print_color $CYAN "Si no se abre, visita manualmente: $CENTRAL_SERVER_URL" "üí° "

print_color $CYAN "Para detener el sistema, ejecuta:" "‚ÑπÔ∏è "
print_color $YELLOW "  docker-compose down" "‚ö†Ô∏è "

print_color $GREEN "¬°Disfruta usando RedP2P! üöÄ" "‚ú® "
